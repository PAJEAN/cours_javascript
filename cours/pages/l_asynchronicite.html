<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Le JavaScript</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="wrapper">
        <div class="page" id="page">
            <header>
                <h1 class="title">L'asynchronicit√©</h1>
                <div class="toolbar">
                    <button class="btn" id="btn-print" title="Imprimer / Exporter en PDF">üñ®Ô∏è Imprimer</button>
                    <button class="btn" id="btn-theme" title="Changer le th√®me" data-initial="light">üåó Th√®me</button>
                </div>
            </header>

            <!-- ----------------------------------------------------------------------- -->
            <!--                                  AJAX                                   -->
            <!-- ----------------------------------------------------------------------- -->

            <p> 
            JavaScript est un langage <b>monothread</b> : il n'ex√©cute qu'une seule instruction √† la fois. Si une op√©ration longue (comme un appel r√©seau ou la lecture d'un fichier) bloquait le fil d'ex√©cution, l'application enti√®re deviendrait inutilisable. Pour √©viter cela, JavaScript repose sur l'<b>asynchronicit√©</b> : certaines op√©rations sont ex√©cut√©es en arri√®re-plan, et leur r√©sultat est trait√© plus tard, sans bloquer l'interface.
            </p>

            <h2> Les promesses (<i>Promises</i>) </h2>

            <p>
            Une <b>promesse</b> est un objet qui repr√©sente la valeur d'une op√©ration asynchrone, mais qui n'est pas encore disponible au moment de sa cr√©ation. Elle peut √™tre dans l'un des trois √©tats suivants :
            </p>

            <ul>
                <li><code>pending</code> : en attente, l'op√©ration est en cours.</li>
                <li><code>fulfilled</code> : termin√©e avec succ√®s, la promesse renvoie une valeur.</li>
                <li><code>rejected</code> : √©chou√©e, la promesse renvoie une erreur.</li>
            </ul>

            <p>
            Lorsqu'une promesse est r√©solue (<code>fulfilled</code> ou <code>rejected</code>), on peut acc√©der √† son r√©sultat via les m√©thodes <code>.then()</code> (succ√®s) et <code>.catch()</code> (erreur).
            </p>

            <div id="cells90"></div>

            <p>
            Les promesses sont aujourd'hui la base de l'asynchronicit√© en JavaScript. Elles sont utilis√©es par de nombreuses API modernes, comme <code>fetch()</code>. Elles peuvent aussi √™tre utilis√©es avec <code>async/await</code> pour convertir une op√©ration asynchrone en code synchrone.
            </p>

            <p>
                Vous pouvez exploiter la m√©thode <code>Promise.all([])</code> pour ex√©cuter plusieurs promesses en parall√®le et attendre que toutes soient termin√©es (ou qu'une √©choue).
            </p>

            <div id="cells91"></div>

            <h2> Les appels AJAX </h2>

            <p>Les appels AJAX (<i>Asynchronous JavaScript & XML</i>) permettent de communiquer entre le <b>client</b> et le <b>serveur</b> de mani√®re asynchrone, c'est-√†-dire sans rechargement complet de la page. Historiquement, on utilisait pour cela l'objet <code>XMLHttpRequest</code> (XHR), mais dans les applications modernes, on pr√©f√®re la m√©thode <code>fetch()</code>, <a href="https://www.greatfrontend.com/questions/quiz/what-are-the-differences-between-xmlhttprequest-and-fetch">plus simple et plus puissante</a>. </p>

            <p> La m√©thode <code>fetch(url, options)</code> permet d'envoyer une requ√™te HTTP. Elle renvoie une <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Promise">promesse</a> qui sera r√©solue lorsque la r√©ponse du serveur est disponible. Par d√©faut, <code>fetch()</code> effectue une requ√™te <code>GET</code>, mais il est possible de configurer d'autres m√©thodes (<code>POST</code>, <code>PUT</code>, <code>DELETE</code>‚Ä¶) via l'objet <code>options</code>. </p>

            <div id="cells92"></div>

            <p> L'objet <code>Response</code> ne contient pas directement le corps de la r√©ponse en JSON mais <b>fournit une repr√©sentation de l'ensemble de la r√©ponse HTTP</b>. Aussi, pour extraire le corps en JSON de l'objet Response, on utilise la m√©thode <code>json()</code>, qui renvoie une deuxi√®me promesse dont la r√©solution fournit le r√©sultat de l'analyse du corps de la r√©ponse au format JSON (<a href="https://developer.mozilla.org/fr/docs/Web/API/Fetch_API/Using_Fetch">developer.mozilla.org</a>). </p>

            <div class="exercise-box">
                <div class="exercise-header">
                    <span class="box-icon">üí°</span>
                    <span class="box-title">Exercice</span>
                </div>
                <div class="box-content">
                    <p> A partir d'une liste d'URLs d'API publiques (<i>"https://jsonplaceholder.typicode.com/todos/1", "https://jsonplaceholder.typicode.com/todos/2" et "https://jsonplaceholder.typicode.com/todos/3"</i>) : </p>
                    <ul>
                        <li> √âcrire une fonction <code>chargerDonnees(urls)</code> qui prend en param√®tre le tableau d'URLs. </li>
                        <li> Utiliser <code>fetch</code> pour r√©cup√©rer les donn√©es de chaque URL. </li>
                        <li> Attendre que toutes les requ√™tes soient termin√©es avec <code>Promise.all</code>. </li>
                        <li> Afficher les r√©sultats dans la console (ou sur la page HTML). </li>
                    </ul>
                </div>
            </div>

            <button class="btn toggle-answer" data-pw="al">
                Afficher la r√©ponse
            </button>
            <div class="hidden">
                <div id="cells93"></div>
            </div>
            
        </div>
    </div>


<!--
88888888888                              888          888            
    888                                  888          888            
    888                                  888          888            
    888   .d88b.  88888b.d88b.  88888b.  888  8888b.  888888 .d88b.  
    888  d8P  Y8b 888 "888 "88b 888 "88b 888     "88b 888   d8P  Y8b 
    888  88888888 888  888  888 888  888 888 .d888888 888   88888888 
    888  Y8b.     888  888  888 888 d88P 888 888  888 Y88b. Y8b.     
    888   "Y8888  888  888  888 88888P"  888 "Y888888  "Y888 "Y8888  
                                888                                  
                                888                                  
                                888                                  
-->

    <template id="cell-template">
        <section class="cell">
            <header>
                <div class="cell-title">
                    <span class="badge">
                        <span class="dot"></span>
                        <span class="title-text">JavaScript</span>
                    </span>
                </div>
                <div class="cell-actions">
                    <button class="btn run">
                        <span class="icon">‚ñ∂</span>
                        <span class="label">Ex√©cuter</span>
                    </button>
                    <button class="btn reset">
                        <span class="icon">‚ü≥</span>
                        <span class="label">R√©initialiser</span>
                    </button>

                    <button class="btn clear">
                        <span class="icon">üßπ</span>
                        <span class="label">Effacer</span>
                    </button>
                </div>
            </header>
            <textarea class="editor" spellcheck="false"></textarea>
            <div class="output" aria-live="polite"></div>
        </section>
    </template>


<!--
 .d8888b.                   d8b          888    
d88P  Y88b                  Y8P          888    
Y88b.                                    888    
 "Y888b.    .d8888b 888d888 888 88888b.  888888 
    "Y88b. d88P"    888P"   888 888 "88b 888    
      "888 888      888     888 888  888 888    
Y88b  d88P Y88b.    888     888 888 d88P Y88b.  
 "Y8888P"   "Y8888P 888     888 88888P"   "Y888 
                                888             
                                888             
                                888             
-->

    <script src="../js/main.js"></script>

    <script>
        /* ==== Add cells ==== */

    addCell('cells90', "L'objet <code>Promise</code>", `
/* /!\\ async/await est utilis√© uniquement pour le bon fonctionnement de la cellule. */

async function getData() {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
        const ok = Math.random() > 0.5; // Succ√®s ou erreur al√©atoire.
        if (ok) {
            resolve('Donn√©es re√ßues !');
        } else {
            reject('Une erreur est survenue.');
        }
        }, 1000); // Ex√©cution apr√®s 1 seconde.
    });
}

await getData()
    .then(result => console.log(result))   // "Donn√©es re√ßues !" si succ√®s.
    .catch(error => console.error(error)); // "Une erreur est survenue." si √©chec.
    `);

    addCell('cells91', 'La fonction <code>Promise.all([])</code>', `
/* /!\\ await est utilis√© uniquement pour le bon fonctionnement de la cellule. */

function attendre(ms, message) {
  return new Promise(resolve => {
    setTimeout(() => resolve(message), ms);
  });
}

// On lance 3 promesses en parall√®le.
const p1 = attendre(500,  'R√©sultat de la promesse 1 (0.5s)');
const p2 = attendre(1500, 'R√©sultat de la promesse 2 (1.5s)');
const p3 = attendre(1000, 'R√©sultat de la promesse 3 (1s)');

// Promise.all attend que TOUTES les promesses soient termin√©es.
await Promise.all([p1, p2, p3])
    .then(resultats => {
        console.log('Toutes les promesses sont r√©solues !');
        console.log(resultats); 
        // ["R√©sultat de la promesse 1 (1s)", 
        //  "R√©sultat de la promesse 2 (2s)", 
        //  "R√©sultat de la promesse 3 (1.5s)"]
    })
    .catch(erreur => {
        console.error("Une promesse a √©chou√© :", erreur);
    });
    `);

    addCell('cells92', 'La fonction <code>fetch()</code>', `
/* /!\\ await est utilis√© uniquement pour le bon fonctionnement de la cellule. */

await fetch('https://api.chucknorris.io/jokes/random', {
        method: 'GET',
        // body: ...
    })
    .then(response => {
        if (!response.ok) {
        throw new Error("Erreur HTTP: " + response.status);
        }
        return response.json(); // conversion de la r√©ponse en JSON
    })
    .then(data => {
        console.log('Donn√©es re√ßues :', data.value);
    })
    .catch(error => {
        console.error('Une erreur est survenue :', error);
    });
    `);

    addCell('cells93', 'R√©ponse', `
/* /!\\ await est utilis√© uniquement pour le bon fonctionnement de la cellule. */

const urls = [
    "https://jsonplaceholder.typicode.com/todos/1",
    "https://jsonplaceholder.typicode.com/todos/2",
    "https://jsonplaceholder.typicode.com/todos/3"
];

async function chargerDonnees(urls) {
    let promises = [];
    for (let url of urls) {
        promises.push(fetch(url, { method: 'GET' })
        .then(response => {
            if (!response.ok) {
                throw new Error("Erreur HTTP: " + response.status);
            }
            return response.json(); // conversion de la r√©ponse en JSON
        }));
    }

    await Promise.all(promises)
    .then(data => {
        console.log('Donn√©es re√ßues :', data);
    })
    .catch(error => {
        console.error('Une erreur est survenue :', error);
    });
}

await chargerDonnees(urls);	
    `);


/*        
    addCell('cells00', '', `

    `);
*/

    </script>
</body>
</html>